{"version":3,"file":"ActorRdfParseHtml.js","sourceRoot":"","sources":["ActorRdfParseHtml.ts"],"names":[],"mappings":"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","sourcesContent":["import { Readable } from 'stream';\nimport type { IActionRdfParse,\n  IActorRdfParseFixedMediaTypesArgs,\n  IActorRdfParseOutput } from '@comunica/bus-rdf-parse';\nimport {\n  ActorRdfParseFixedMediaTypes,\n} from '@comunica/bus-rdf-parse';\nimport type {\n  IActionRdfParseHtml,\n  IActorRdfParseHtmlOutput,\n  IHtmlParseListener,\n} from '@comunica/bus-rdf-parse-html';\nimport type { ActionContext, Actor, Bus, IActorTest } from '@comunica/core';\nimport { WritableStream as HtmlParser } from 'htmlparser2/lib/WritableStream';\nimport type * as RDF from 'rdf-js';\n\n/**\n * A comunica HTML RDF Parse Actor.\n * It creates an HTML parser, and delegates its events via the bus-rdf-parse-html bus to other HTML parsing actors.\n */\nexport class ActorRdfParseHtml extends ActorRdfParseFixedMediaTypes {\n  private readonly busRdfParseHtml: Bus<Actor<IActionRdfParseHtml, IActorTest,\n  IActorRdfParseHtmlOutput>, IActionRdfParseHtml, IActorTest, IActorRdfParseHtmlOutput>;\n\n  public constructor(args: IActorRdfParseHtmlArgs) {\n    super(args);\n  }\n\n  public async runHandle(action: IActionRdfParse, mediaType: string, context: ActionContext):\n  Promise<IActorRdfParseOutput> {\n    const quads = new Readable({ objectMode: true });\n    quads._read = async() => {\n      // Only initialize once\n      quads._read = () => {\n        // Do nothing\n      };\n\n      // Create callbacks action\n      let endBarrier = 1;\n      function emit(quad: RDF.Quad): void {\n        quads.emit('data', quad);\n      }\n      function error(subError: unknown): void {\n        quads.emit('error', subError);\n      }\n      function end(): void {\n        if (--endBarrier === 0) {\n          quads.push(null);\n        }\n      }\n      const htmlAction = {\n        baseIRI: action.baseIRI,\n        context,\n        emit,\n        end,\n        error,\n        headers: action.headers,\n      };\n\n      // Register html parse listeners\n      Promise.all(this.busRdfParseHtml.publish(htmlAction))\n        .then(async outputs => {\n          endBarrier += outputs.length;\n\n          const htmlParseListeners: IHtmlParseListener[] = [];\n          for (const output of outputs) {\n            const { htmlParseListener } = await output.actor.run(htmlAction);\n            htmlParseListeners.push(htmlParseListener);\n          }\n\n          // Create parser\n          const parser = new HtmlParser({\n            onclosetag() {\n              try {\n                for (const htmlParseListener of htmlParseListeners) {\n                  htmlParseListener.onTagClose();\n                }\n              } catch (error_: unknown) {\n                error(error_);\n              }\n            },\n            onend() {\n              try {\n                for (const htmlParseListener of htmlParseListeners) {\n                  htmlParseListener.onEnd();\n                }\n              } catch (error_: unknown) {\n                error(error_);\n              }\n              end();\n            },\n            onopentag(name: string, attributes: Record<string, string>) {\n              try {\n                for (const htmlParseListener of htmlParseListeners) {\n                  htmlParseListener.onTagOpen(name, attributes);\n                }\n              } catch (error_: unknown) {\n                error(error_);\n              }\n            },\n            ontext(data: string) {\n              try {\n                for (const htmlParseListener of htmlParseListeners) {\n                  htmlParseListener.onText(data);\n                }\n              } catch (error_: unknown) {\n                error(error_);\n              }\n            },\n          }, {\n            decodeEntities: true,\n            recognizeSelfClosing: true,\n            xmlMode: false,\n          });\n\n          // Push stream to parser\n          action.input.on('error', error);\n          action.input.pipe(<any> parser);\n        }).catch(error);\n    };\n\n    return { quads };\n  }\n}\n\nexport interface IActorRdfParseHtmlArgs extends IActorRdfParseFixedMediaTypesArgs {\n  busRdfParseHtml: Bus<Actor<IActionRdfParseHtml, IActorTest, IActorRdfParseHtmlOutput>,\n  IActionRdfParseHtml, IActorTest, IActorRdfParseHtmlOutput>;\n}\n"]}